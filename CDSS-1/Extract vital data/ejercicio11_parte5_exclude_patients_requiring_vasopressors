{"cells":[{"cell_type":"markdown","id":"adjusted-jersey","metadata":{"id":"adjusted-jersey"},"source":["# Exclude patients using vasopressors (aline study step 5)\n","Indwelling arterial catheters (IACs) are being used to monitor hemodynamics and also for blood gas analysis. However, those catheters  pose serious risks such as infections or vascular problems. The MIMIC-III dataset can be used to study if IAC use is associated with mortality in patients on the ICU. The queries in this notebook are based on the following paper:\n","\n","Hsu, D. J., Feng, M., Kothari, R., Zhou, H., Chen, K. P., & Celi, L. A. (2015). The association between indwelling arterial catheters and mortality in hemodynamically stable patients with respiratory failure: a propensity score analysis. Chest, 148(6), 1470-1476. <br><br>\n","\n","__Exclude patients using vasopressors:__\n","\n","We will exclude patients who are using vasopressors."]},{"cell_type":"code","execution_count":null,"id":"greenhouse-combat","metadata":{"id":"greenhouse-combat"},"outputs":[],"source":["# Imports:\n","import numpy as np\n","import pandas as pd\n","import matplotlib.pyplot as plt\n","from matplotlib import cm\n","import psycopg2\n","%matplotlib inline"]},{"cell_type":"code","execution_count":null,"id":"refined-imagination","metadata":{"id":"refined-imagination"},"outputs":[],"source":["# Configuration:\n","sqluser = 'postgres'\n","dbname = 'mimic'\n","password = 'postgres'\n","schema_name = 'mimiciii, public'\n","\n","# Connect to MIMIC\n","con = psycopg2.connect(dbname=dbname, user=sqluser, password=password)\n","cur = con.cursor()\n","\n","# Function to execute a query safely, used when we create a new table:\n","def execute_query_safely(sql, con, cur):\n","    cur = con.cursor()\n","    try:\n","        cur.execute(sql)\n","    except (Exception, psycopg2.DatabaseError) as error:\n","        print(error)\n","    finally:\n","        cur.close()\n","    return"]},{"cell_type":"code","execution_count":null,"id":"regulation-growing","metadata":{"id":"regulation-growing"},"outputs":[],"source":["vasopressor_ids = \\\n","{\n","    'vasopressors_mv_table': (221906, 221289, 221749, 222315, 221662, 227692),\n","    'vasopressors_cv_table': (30047, 30120, 30044, 30119, 30309, 30127, 30128, 30051, 30043, 30307, 30125, 30046)\n","}"]},{"cell_type":"code","execution_count":null,"id":"excited-zambia","metadata":{"id":"excited-zambia"},"outputs":[],"source":["query = \\\n","\"\"\"\n","with mv_vasopressors as (\n","    SELECT mv.icustay_id\n","    FROM mimiciii.inputevents_mv mv\n","    WHERE mv.itemid in \"\"\" + str(vasopressor_ids['vasopressors_mv_table']) + \"\"\"\n","    AND mv.rate is not null AND mv.rate > 0 and mv.statusdescription != 'Rewritten'\n","),\n","cv_vasopressors as (\n","    SELECT cv.icustay_id\n","    FROM mimiciii.inputevents_cv cv\n","    WHERE cv.itemid in \"\"\" + str(vasopressor_ids['vasopressors_cv_table']) + \"\"\"\n","    AND cv.rate is not null AND cv.rate > 0\n","),\n","vasopressor_table as (\n","    SELECT ap.icustay_id,\n","    max(case when coalesce(mv.icustay_id, cv.icustay_id) is null then 0 else 1 end) as vaso_flag\n","    FROM adult_patients ap\n","    LEFT JOIN mv_vasopressors mv ON ap.icustay_id = mv.icustay_id\n","    LEFT JOIN cv_vasopressors cv ON ap.icustay_id = cv.icustay_id\n","    GROUP BY ap.icustay_id\n",")\n","UPDATE adult_patients\n","SET exclusion_vasopressors = vasopressor_table.vaso_flag\n","FROM vasopressor_table WHERE adult_patients.icustay_id = vasopressor_table.icustay_id\n","\"\"\"\n","\n","query_schema = 'SET SEARCH_PATH TO public, mimiciii;'\n","execute_query_safely(query_schema + query, con, cur)"]},{"cell_type":"code","execution_count":null,"id":"sorted-paint","metadata":{"id":"sorted-paint"},"outputs":[],"source":["# Commit to the database:\n","con.commit()"]},{"cell_type":"code","execution_count":null,"id":"narrative-dryer","metadata":{"id":"narrative-dryer","outputId":"6a620f95-9df3-49c3-c146-2487dd3a4a97"},"outputs":[{"name":"stdout","output_type":"stream","text":["Subjects excluded because of using vasopressors:  17399\n"]}],"source":["# Check if the number of excluded subject is correct:\n","query = \"\"\" SELECT * FROM adult_patients \"\"\"\n","query_output = pd.read_sql_query(query, con)\n","print('Subjects excluded because of using vasopressors: ',\n","      query_output['exclusion_vasopressors'].sum())"]},{"cell_type":"code","execution_count":null,"id":"corresponding-rolling","metadata":{"id":"corresponding-rolling"},"outputs":[],"source":["# Close the connection:\n","con.close()"]}],"metadata":{"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.8.6"},"colab":{"provenance":[]}},"nbformat":4,"nbformat_minor":5}
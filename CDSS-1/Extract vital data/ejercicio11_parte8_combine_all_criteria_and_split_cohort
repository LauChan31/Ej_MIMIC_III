{"cells":[{"cell_type":"markdown","id":"adjusted-jersey","metadata":{"id":"adjusted-jersey"},"source":["# MIMIC-III queries on the aline study\n","Indwelling arterial catheters (IACs) are being used to monitor hemodynamics and also for blood gas analysis. However, those catheters  pose serious risks such as infections or vascular problems. The MIMIC-III dataset can be used to study if IAC use is associated with mortality in patients on the ICU. The queries in this notebook are based on the following paper:\n","\n","Hsu, D. J., Feng, M., Kothari, R., Zhou, H., Chen, K. P., & Celi, L. A. (2015). The association between indwelling arterial catheters and mortality in hemodynamically stable patients with respiratory failure: a propensity score analysis. Chest, 148(6), 1470-1476."]},{"cell_type":"code","execution_count":null,"id":"greenhouse-combat","metadata":{"id":"greenhouse-combat"},"outputs":[],"source":["# Imports:\n","import numpy as np\n","import pandas as pd\n","import matplotlib.pyplot as plt\n","from matplotlib import cm\n","import psycopg2\n","%matplotlib inline"]},{"cell_type":"code","execution_count":null,"id":"refined-imagination","metadata":{"id":"refined-imagination"},"outputs":[],"source":["# Configuration:\n","sqluser = 'postgres'\n","dbname = 'mimic'\n","password = 'postgres'\n","schema_name = 'mimiciii, public'\n","\n","# Connect to MIMIC\n","con = psycopg2.connect(dbname=dbname, user=sqluser, password=password)\n","cur = con.cursor()\n","\n","# Function to execute a query safely, used when we create a new table:\n","def execute_query_safely(sql, con, cur):\n","    cur = con.cursor()\n","    try:\n","        cur.execute(sql)\n","    except (Exception, psycopg2.DatabaseError) as error:\n","        print(error)\n","    finally:\n","        cur.close()\n","    return"]},{"cell_type":"code","execution_count":null,"id":"synthetic-october","metadata":{"id":"synthetic-october","outputId":"b2dce188-9b0b-4e30-c699-cc2ea5b198de"},"outputs":[{"name":"stdout","output_type":"stream","text":["Number of subjects after exclusion: 2522\n"]},{"data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>subject_id</th>\n","      <th>hadm_id</th>\n","      <th>icustay_id</th>\n","      <th>intime</th>\n","      <th>outtime</th>\n","      <th>exclusion_readmission_and_los</th>\n","      <th>exclusion_mechanical_ventilation</th>\n","      <th>exclusion_sepsis</th>\n","      <th>exclusion_vasopressors</th>\n","      <th>exclusion_prior_iac_placement</th>\n","      <th>exclusion_csru</th>\n","      <th>iac_group</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>183</td>\n","      <td>113341</td>\n","      <td>252525</td>\n","      <td>2188-07-03 16:00:00</td>\n","      <td>2188-07-04 19:44:36</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>None</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>248</td>\n","      <td>175353</td>\n","      <td>219979</td>\n","      <td>2142-10-19 16:15:00</td>\n","      <td>2142-11-01 12:51:28</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>None</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>249</td>\n","      <td>116935</td>\n","      <td>215044</td>\n","      <td>2149-12-18 20:00:00</td>\n","      <td>2149-12-24 13:31:45</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>None</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>266</td>\n","      <td>186251</td>\n","      <td>293876</td>\n","      <td>2168-07-10 09:10:00</td>\n","      <td>2168-07-11 17:40:38</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>None</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>273</td>\n","      <td>158689</td>\n","      <td>241507</td>\n","      <td>2141-04-19 07:15:00</td>\n","      <td>2141-04-20 17:52:11</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>0</td>\n","      <td>None</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["   subject_id  hadm_id  icustay_id              intime             outtime  \\\n","0         183   113341      252525 2188-07-03 16:00:00 2188-07-04 19:44:36   \n","1         248   175353      219979 2142-10-19 16:15:00 2142-11-01 12:51:28   \n","2         249   116935      215044 2149-12-18 20:00:00 2149-12-24 13:31:45   \n","3         266   186251      293876 2168-07-10 09:10:00 2168-07-11 17:40:38   \n","4         273   158689      241507 2141-04-19 07:15:00 2141-04-20 17:52:11   \n","\n","   exclusion_readmission_and_los  exclusion_mechanical_ventilation  \\\n","0                              0                                 0   \n","1                              0                                 0   \n","2                              0                                 0   \n","3                              0                                 0   \n","4                              0                                 0   \n","\n","   exclusion_sepsis  exclusion_vasopressors  exclusion_prior_iac_placement  \\\n","0                 0                       0                              0   \n","1                 0                       0                              0   \n","2                 0                       0                              0   \n","3                 0                       0                              0   \n","4                 0                       0                              0   \n","\n","   exclusion_csru iac_group  \n","0               0      None  \n","1               0      None  \n","2               0      None  \n","3               0      None  \n","4               0      None  "]},"execution_count":4,"metadata":{},"output_type":"execute_result"}],"source":["query = \\\n","\"\"\"\n","SELECT * FROM adult_patients ap\n","WHERE ap.exclusion_readmission_and_los != 1\n","AND ap.exclusion_mechanical_ventilation != 1\n","AND ap.exclusion_sepsis != 1\n","AND ap.exclusion_vasopressors != 1\n","AND ap.exclusion_prior_iac_placement != 1\n","AND ap.exclusion_csru != 1\n","\"\"\"\n","\n","query_output = pd.read_sql_query(query, con)\n","print('Number of subjects after exclusion:', query_output['subject_id'].count())\n","query_output.head()"]},{"cell_type":"markdown","id":"opposed-fruit","metadata":{"id":"opposed-fruit"},"source":["### Split into IAC and non-IAC groups"]},{"cell_type":"code","execution_count":null,"id":"acute-investigator","metadata":{"id":"acute-investigator"},"outputs":[],"source":["iac_placement_ids = \\\n","{\n","    'itemids_iac': (51, 6701, 220050, 8368, 8555, 220051, 52, 6702, 220052, 225312)\n","}"]},{"cell_type":"code","execution_count":null,"id":"tight-words","metadata":{"id":"tight-words"},"outputs":[],"source":["query = \"\"\"\n","with iac_placement_table AS (\n","    SELECT ce.icustay_id, min(ce.charttime) as iac_time\n","    FROM mimiciii.chartevents ce\n","    WHERE ce.itemid in \"\"\" + str(iac_placement_ids['itemids_iac']) + \"\"\"\n","    AND ce.valuenum is not null AND ce.icustay_id is not null\n","    GROUP BY ce.icustay_id\n","),\n","adult_patients_iac AS (\n","    SELECT ap.icustay_id,\n","    CASE\n","        WHEN ipt.iac_time is not null THEN 1\n","        ELSE 0 end as iac_placed\n","    FROM adult_patients ap\n","    LEFT JOIN iac_placement_table ipt ON ap.icustay_id = ipt.icustay_id\n",")\n","UPDATE adult_patients\n","SET iac_group = adult_patients_iac.iac_placed\n","FROM adult_patients_iac\n","WHERE adult_patients.icustay_id = adult_patients_iac.icustay_id\n","\"\"\"\n","\n","query_schema = 'SET SEARCH_PATH TO public, mimiciii;'\n","execute_query_safely(query_schema + query, con, cur)"]},{"cell_type":"code","execution_count":null,"id":"exclusive-spanking","metadata":{"id":"exclusive-spanking","outputId":"82f0fec8-e0e5-4cc9-8121-b889b544f68b"},"outputs":[{"name":"stdout","output_type":"stream","text":["Number of subjects in the IAC group: 1298\n","Number of subjects in the not-IAC group: 1224\n"]}],"source":["query = \\\n","\"\"\"\n","SELECT * FROM adult_patients ap\n","WHERE ap.exclusion_readmission_and_los != 1\n","AND ap.exclusion_mechanical_ventilation != 1\n","AND ap.exclusion_sepsis != 1\n","AND ap.exclusion_vasopressors != 1\n","AND ap.exclusion_prior_iac_placement != 1\n","AND ap.exclusion_csru != 1\n","\"\"\"\n","\n","query_output = pd.read_sql_query(query, con)\n","print('Number of subjects in the IAC group:', query_output['iac_group'].sum())\n","print('Number of subjects in the not-IAC group:', query_output['subject_id'].count() - query_output['iac_group'].sum())"]},{"cell_type":"code","execution_count":null,"id":"smoking-retreat","metadata":{"id":"smoking-retreat"},"outputs":[],"source":["# Commit to the database and close the connection:\n","con.commit()\n","con.close()"]}],"metadata":{"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.8.6"},"colab":{"provenance":[]}},"nbformat":4,"nbformat_minor":5}